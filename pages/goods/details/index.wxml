<view class="dish-detail-page">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <t-skeleton theme="paragraph" animation="gradient" loading>
      <view style="height: 750rpx; width: 100%; margin-bottom: 24rpx;"></view>
      <view style="height: 80rpx; width: 80%; margin-bottom: 16rpx;"></view>
      <view style="height: 60rpx; width: 90%; margin-bottom: 16rpx;"></view>
      <view style="height: 40rpx; width: 60%; margin-bottom: 24rpx;"></view>
      <view style="height: 100rpx; width: 100%; margin-bottom: 24rpx;"></view>
      <view style="height: 240rpx; width: 100%"></view>
    </t-skeleton>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>
  
  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-container" wx:elif="{{empty}}">
    <t-empty description="èœå“ä¿¡æ¯ä¸å­˜åœ¨" />
    <view class="empty-tips">è¯¥èœå“å¯èƒ½å·²ä¸‹æ¶ï¼Œè¯·è¿”å›æŸ¥çœ‹å…¶ä»–èœå“</view>
    <t-button size="medium" theme="primary" bindtap="backToList" class="back-btn">è¿”å›èœå“åˆ—è¡¨</t-button>
  </view>
  
  <!-- èœå“è¯¦æƒ… -->
  <block wx:else>
    <!-- èœå“å›¾ç‰‡è½®æ’­ -->
    <t-swiper
      wx:if="{{details.images && details.images.length > 0}}"
      height="750rpx"
      current="{{current}}"
      autoplay="{{autoplay}}"
      duration="{{duration}}"
      interval="{{interval}}"
      navigation="{{navigation}}"
      list="{{details.images}}"
      bind:click="showCurImg"
      class="dish-swiper"
      image-props="{{ {shape: 'round', loading: 'lazy'} }}"
    ></t-swiper>
    <view wx:else class="dish-default-img">
      <t-image src="{{details.thumb || details.primaryImage || '/pages/goods/assets/images/dish-placeholder.png'}}" mode="aspectFill" loading="{{true}}" shape="round" />
    </view>
    
    <!-- èœå“åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
    <view class="dish-info">
      <!-- èœå“æ ‡é¢˜å’Œåˆ†äº« -->
      <view class="dish-title-row">
        <view class="dish-name">{{details.title || details.name}}</view>
        <view class="dish-share">
          <button open-type="share" class="share-btn" hover-class="share-btn-hover">
            <view class="btn-icon">
              <t-icon name="share" size="36rpx" color="#666" />
              <text class="share-text">åˆ†äº«</text>
            </view>
          </button>
        </view>
      </view>
      
      <!-- èœå“ä»·æ ¼å’Œè¯„åˆ† -->
      <view class="dish-price-row">
        <view class="dish-price">
          <text class="price-symbol">Â¥</text>
          <text class="price-integer">{{details.price/100}}</text>
          <text class="price-original" wx:if="{{details.originalPrice && details.originalPrice > details.price}}">Â¥{{details.originalPrice/100}}</text>
        </view>
        <view class="dish-sales">
          <text class="sales-count" wx:if="{{details.soldNum}}">å·²å”® {{details.soldNum}}</text>
          <text class="stock-count" wx:if="{{details.stock_quantity}}">åº“å­˜ {{details.stock_quantity}}</text>
          <view class="dish-rating" wx:if="{{details.rating}}">
            <t-rate value="{{details.rating}}" size="12" gap="2" color="{{['#FFD21D', '#ddd']}}" />
          </view>
        </view>
      </view>
      
      <!-- èœå“æ ‡ç­¾ -->
      <view class="dish-tags" wx:if="{{details.tags && details.tags.length > 0 || details.spicyLevel > 0 || details.cookingTime > 0 || details.recommendation >= 4}}">
        <text class="tag" wx:for="{{details.tags}}" wx:key="*this">{{item}}</text>
        <text class="tag cooking-time" wx:if="{{details.cookingTime}}">åˆ¶ä½œæ—¶é—´ {{details.cookingTime}}åˆ†é’Ÿ</text>
        <text class="tag spicy-level" wx:if="{{details.spicyLevel}}">è¾£åº¦ 
          <text class="spicy-icon" wx:for="{{details.spicyLevel}}" wx:key="*this">ğŸŒ¶</text>
        </text>
        <text class="tag recommend" wx:if="{{details.recommendation >= 4}}">æ¨èæŒ‡æ•° {{details.recommendation}}</text>
      </view>
      
      <!-- ç®€è¦è¥å…»ä¿¡æ¯ -->
      <view class="nutrition-brief" wx:if="{{details.nutrition}}">
        <view class="nutrition-item" wx:if="{{details.nutrition.calories}}">
          <text class="nutrition-value">{{details.nutrition.calories}}</text>
          <text class="nutrition-label">çƒ­é‡(kcal)</text>
        </view>
        <view class="nutrition-item" wx:if="{{details.nutrition.protein}}">
          <text class="nutrition-value">{{details.nutrition.protein}}g</text>
          <text class="nutrition-label">è›‹ç™½è´¨</text>
        </view>
        <view class="nutrition-item" wx:if="{{details.nutrition.carbs}}">
          <text class="nutrition-value">{{details.nutrition.carbs}}g</text>
          <text class="nutrition-label">ç¢³æ°´</text>
        </view>
        <view class="nutrition-item" wx:if="{{details.nutrition.fat}}">
          <text class="nutrition-value">{{details.nutrition.fat}}g</text>
          <text class="nutrition-label">è„‚è‚ª</text>
        </view>
      </view>
      
      <!-- èœå“æè¿° -->
      <view class="dish-desc">{{details.description || details.desc || 'æš‚æ— èœå“æè¿°'}}</view>
    </view>
    
    <!-- è§„æ ¼é€‰æ‹© -->
    <view class="specs-section" wx:if="{{details.specList && details.specList.length > 0}}">
      <view class="section-title">
        <text class="title-icon"></text>
        <text class="title-text">è§„æ ¼é€‰æ‹©</text>
      </view>
      <view class="specs-list">
        <view class="specs-item" wx:for="{{details.specList}}" wx:key="specId">
          <view class="specs-name">{{item.title || item.specName}}</view>
          <view class="specs-values">
            <view 
              class="spec-value {{selectedSpecs[item.specId] === specValue.specValueId ? 'selected' : ''}}" 
              wx:for="{{item.specValueList}}" 
              wx:for-item="specValue" 
              wx:key="specValueId" 
              data-spec-id="{{item.specId}}"
              data-spec-value-id="{{specValue.specValueId}}"
              data-spec-value="{{specValue.specValue}}"
              bindtap="handleSpecsClick"
            >
              {{specValue.specValue}}
              <text wx:if="{{specValue.price_adjust > 0}}" class="price-adjust">+Â¥{{specValue.price_adjust/100}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- èœå“è¯¦æƒ… -->
    <view class="details-section">
      <view class="section-title">
        <text class="title-icon"></text>
        <text class="title-text">èœå“è¯¦æƒ…</text>
      </view>
      <view class="details-content">
        <!-- èœå“ç‰¹ç‚¹ -->
        <view class="details-item" wx:if="{{details.features && details.features.length > 0}}">
          <view class="item-title">èœå“ç‰¹ç‚¹</view>
          <view class="item-content feature-list">
            <view class="feature-item" wx:for="{{details.features}}" wx:key="*this">
              <t-icon name="check-circle-filled" size="32rpx" color="#8B572A" />
              <text class="feature-text">{{item}}</text>
            </view>
          </view>
        </view>
        
        <!-- èœå“åŸæ–™ -->
        <view class="details-item" wx:if="{{details.ingredients && details.ingredients.length > 0}}">
          <view class="item-title">ä¸»è¦åŸæ–™</view>
          <view class="item-content">{{details.ingredients.join('ã€')}}</view>
        </view>
        
        <!-- è¥å…»æˆåˆ†è¯¦æƒ… -->
        <view class="details-item" wx:if="{{details.nutrition}}">
          <view class="item-title">è¥å…»æˆåˆ†</view>
          <view class="item-content nutrition-detail-list">
            <view class="nutrition-detail-item" wx:if="{{details.nutrition.calories}}">
              <text class="nutrition-name">çƒ­é‡</text>
              <text class="nutrition-value">{{details.nutrition.calories}} åƒå¡</text>
            </view>
            <view class="nutrition-detail-item" wx:if="{{details.nutrition.protein}}">
              <text class="nutrition-name">è›‹ç™½è´¨</text>
              <text class="nutrition-value">{{details.nutrition.protein}} å…‹</text>
            </view>
            <view class="nutrition-detail-item" wx:if="{{details.nutrition.carbs}}">
              <text class="nutrition-name">ç¢³æ°´åŒ–åˆç‰©</text>
              <text class="nutrition-value">{{details.nutrition.carbs}} å…‹</text>
            </view>
            <view class="nutrition-detail-item" wx:if="{{details.nutrition.fat}}">
              <text class="nutrition-name">è„‚è‚ª</text>
              <text class="nutrition-value">{{details.nutrition.fat}} å…‹</text>
            </view>
          </view>
        </view>
        
        <!-- æ¨èæ­é… -->
        <view class="details-item" wx:if="{{details.recommendations && details.recommendations.length > 0}}">
          <view class="item-title">æ¨èæ­é…</view>
          <view class="item-content">{{details.recommendations.join('ã€')}}</view>
        </view>
        
        <!-- åˆ¶ä½œå·¥è‰º -->
        <view class="details-item" wx:if="{{details.cookingMethod}}">
          <view class="item-title">åˆ¶ä½œå·¥è‰º</view>
          <view class="item-content">{{details.cookingMethod}}</view>
        </view>
        
        <!-- é£Ÿç”¨å»ºè®® -->
        <view class="details-item" wx:if="{{details.eatingTips}}">
          <view class="item-title">é£Ÿç”¨å»ºè®®</view>
          <view class="item-content">{{details.eatingTips}}</view>
        </view>
        
        <!-- è¯¦ç»†æè¿° -->
        <view class="details-item" wx:if="{{details.detail}}">
          <view class="item-title">è¯¦ç»†æè¿°</view>
          <rich-text nodes="{{details.detail}}" class="item-content"></rich-text>
        </view>
      </view>
    </view>
    
    <!-- èœå“è¯„ä»· -->
    <view class="comments-section">
      <view class="section-title">
        <text class="title-icon"></text>
        <text class="title-text">èœå“è¯„ä»·</text>
        <view class="view-all" bindtap="navToCommentsListPage">
          <text>{{details.comments && (details.comments.total > 0 || details.comments.topComments.length > 0) ? 'æŸ¥çœ‹å…¨éƒ¨' : 'å†™è¯„ä»·'}}</text>
          <t-icon name="chevron-right" size="32rpx" color="#888" />
        </view>
      </view>
      
      <!-- æœ‰è¯„è®ºæ—¶æ˜¾ç¤ºè¯„è®ºåˆ—è¡¨ -->
      <view class="comments-list" wx:if="{{details.comments && details.comments.topComments && details.comments.topComments.length > 0 || commentsList && commentsList.length > 0}}">
        <!-- ä½¿ç”¨details.comments.topComments -->
        <block wx:if="{{details.comments && details.comments.topComments && details.comments.topComments.length > 0}}">
          <view class="comment-item" wx:for="{{details.comments.topComments}}" wx:key="index">
            <view class="comment-user">
              <t-image class="user-avatar" src="{{item.avatar}}" shape="circle" />
              <view class="user-info">
                <view class="user-name">{{item.userName}}</view>
                <view class="comment-time">{{item.createTime}}</view>
              </view>
              <t-rate value="{{item.rating}}" size="12" gap="2" color="{{['#FFD21D', '#ddd']}}" />
            </view>
            <view class="comment-content">{{item.content}}</view>
            <view class="comment-images" wx:if="{{item.images && item.images.length > 0}}">
              <t-image 
                wx:for="{{item.images}}" 
                wx:for-item="img" 
                wx:key="*this" 
                class="comment-image" 
                src="{{img}}" 
                mode="aspectFill" 
                bindtap="previewImage" 
                data-urls="{{item.images}}" 
                data-current="{{img}}"
              />
            </view>
          </view>
        </block>
        
        <!-- ä½¿ç”¨commentsList -->
        <block wx:elif="{{commentsList && commentsList.length > 0}}">
          <view class="comment-item" wx:for="{{commentsList}}" wx:key="index">
            <view class="comment-user">
              <t-image class="user-avatar" src="{{item.avatar || item.user_avatar || '/pages/goods/assets/images/avatar-placeholder.png'}}" shape="circle" />
              <view class="user-info">
                <view class="user-name">{{item.userName || item.user_name || 'åŒ¿åç”¨æˆ·'}}</view>
                <view class="comment-time">{{item.createTime || item.create_time || ''}}</view>
              </view>
              <t-rate value="{{item.rating || 5}}" size="12" gap="2" color="{{['#FFD21D', '#ddd']}}" />
            </view>
            <view class="comment-content">{{item.content || ''}}</view>
            <view class="comment-images" wx:if="{{item.images && item.images.length > 0}}">
              <t-image 
                wx:for="{{item.images}}" 
                wx:for-item="img" 
                wx:key="*this" 
                class="comment-image" 
                src="{{img}}" 
                mode="aspectFill" 
                bindtap="previewImage" 
                data-urls="{{item.images}}" 
                data-current="{{img}}"
              />
            </view>
          </view>
        </block>
      </view>
      
      <!-- æ— è¯„è®ºæ—¶æ˜¾ç¤ºæç¤º -->
      <view class="no-comments" wx:else>
        <view class="no-comments-icon">
          <t-icon name="chat" size="60rpx" color="#cccccc" />
        </view>
        <view class="no-comments-text">æš‚æ— è¯„ä»·</view>
        <view class="no-comments-tips">æˆä¸ºç¬¬ä¸€ä¸ªè¯„ä»·è¿™é“èœçš„äººå§</view>
        <t-button size="small" theme="light" bindtap="navToCommentsListPage" class="write-comment-btn">å†™è¯„ä»·</t-button>
      </view>
    </view>
    
    <!-- ç›¸å…³æ¨è -->
    <view class="recommend-section" wx:if="{{details.related_dishes && details.related_dishes.length > 0 || recommendList && recommendList.length > 0}}">
      <view class="section-title">
        <text class="title-icon"></text>
        <text class="title-text">ç›¸å…³æ¨è</text>
      </view>
      <scroll-view class="recommend-list" scroll-x="true" enhanced="true" show-scrollbar="false">
        <block wx:if="{{details.related_dishes && details.related_dishes.length > 0}}">
          <view class="recommend-item" wx:for="{{details.related_dishes}}" wx:key="id" bindtap="goToDishDetail" data-id="{{item.spuId || item.dishId}}">
            <t-image class="recommend-image" src="{{item.thumb || '/pages/goods/assets/images/dish-placeholder.png'}}" mode="aspectFill" />
            <view class="recommend-name">{{item.title}}</view>
            <view class="recommend-price">Â¥{{item.price/100}}</view>
          </view>
        </block>
        <block wx:else>
          <view class="recommend-item" wx:for="{{recommendList}}" wx:key="id" bindtap="goToDishDetail" data-id="{{item.spuId || item.dishId}}">
            <t-image class="recommend-image" src="{{item.thumb || item.primaryImage || '/pages/goods/assets/images/dish-placeholder.png'}}" mode="aspectFill" />
            <view class="recommend-name">{{item.title || item.name}}</view>
            <view class="recommend-price">Â¥{{item.price/100}}</view>
          </view>
        </block>
      </scroll-view>
    </view>
    
    <!-- åº•éƒ¨ç©ºç™½åŒºåŸŸï¼Œç¡®ä¿å†…å®¹ä¸è¢«åº•éƒ¨å¯¼èˆªæ é®æŒ¡ -->
    <view class="detail-content-padding"></view>
  </block>
  
  <!-- åº•éƒ¨æ“ä½œåŒº -->
  <view class="category-bottom-bar {{isIPhoneX ? 'isIPhoneX' : ''}}" style="position: fixed; bottom: 0; left: 0; right: 0; width: 100%; z-index: 100;">
    <buy-bar-simple-container
      id="buy-bar"
      cartNum="{{cartNum}}"
      totalPrice="{{cartTotalPrice}}"
      cartList="{{cartList}}"
      showMinPrice="{{false}}"
      isIPhoneX="{{isIPhoneX}}"
      bind:toAddCart="toAddCart"
      bind:toBuyNow="buyItNow"
      bind:fetchCartList="fetchCartList"
      bind:clearCart="clearCart"
      bind:updateCartItem="updateCartItem"
      class="buy-bar-component"
    />
  </view>
</view>

<!-- æç¤ºç»„ä»¶ -->
<t-toast id="t-toast" />
